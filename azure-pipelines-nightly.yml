---
trigger:
  - none

pr: 
  - none

schedules:
- cron: "0 0 * * *"
  displayName: Daily midnight build
  branches:
    include:
    - master
  always: true

parameters:
  - name: environments
    type: object
    default: 
    - name: test
      subscription: DTS-SHAREDSERVICES-TEST
      group: HMI-APIM-BUILD-TEST
      tests_gradle:
      - name: UnitTest 
        command: clean test
      - name: SmokeTest
        command: clean smoke
        dependsOn: UnitTest
      - name: FunctionalTest
        command: clean functional
        dependsOn: SmokeTest

variables:
  - group: HMI-APIM-Common

stages:

- ${{ each environment in parameters.environments }}:

  - stage: ${{ environment.name }}
    ${{ if environment.condition }}:
      condition: ${{ environment.condition }}
    displayName: Build and Test ${{ environment.name }} APIM
    
    jobs:
    - template: pipeline/jobs/create-storage.yaml
      parameters:
        subscription: ${{ environment.subscription }}
        resourceGroup: hmi-apim-${{ environment.name }}-rg

    - template: pipeline/jobs/terraform.yaml
      parameters:
        dependsOn: deleteResources
        subscription: ${{ environment.subscription }} 
        group: ${{ environment.group }}
        displayName: Build infrastructure with Terraform

    - template: pipeline/jobs/export-keyvault.yaml
      parameters:
        displayName: Read KeyVault Secret
        dependsOn: Terraform
        subscription: ${{ environment.subscription }}
        keyVaultName: hmi-apim-kv-${{ environment.name }}

    - ${{ if environment.tests_gradle }}:
      - ${{ each test in environment.tests_gradle }}:

        - template: pipeline/jobs/gradle-test.yaml
          parameters:
            displayName: ${{ test.name }}
            dependsOn: 
            - ExportKeyVault
            - ${{ if parameters.dependsOn }}:
              - ${{ parameters.dependsOn }}
            apimHost: hmi-apim-svc-${{ environment.name }}.azure-api.net
            command: ${{ test.command }}
            subscriptionKey: $(subscriptionKey)
            variables: 
              subscriptionKey: $[dependencies.ExportKeyVault.outputs['exportKeyVaultSecret.hmi-apim-sub-key']]
