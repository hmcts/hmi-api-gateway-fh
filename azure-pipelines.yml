---
trigger:
  - master
pr:
  - none

resources:
  repositories:
    - repository: azTemplates
      type: github
      name: hmcts/azure-devops-templates
      ref: refs/heads/tf-testing
      endpoint: hmcts

parameters:

  - name: environments
    type: object
    default:
      - sbox
      - dev
      - test
      - stg
      - prod

  - name: stage
    displayName: Stage to Run
    type: string
    default: SBOX
    values:
      - SBOX
      - DEV
      - TEST
      - STG
      - NONPROD
      - ALL

  - name: environments
    type: object
    default:
    - name: sbox
      subscription: DTS-SHAREDSERVICES-SBOX
      group: HMI-APIM-BUILD-SBOX

    - name: dev
      subscription: DTS-SHAREDSERVICES-DEV
      group: HMI-APIM-BUILD-DEV

    - name: test
      subscription: DTS-SHAREDSERVICES-TEST
      group: HMI-APIM-BUILD-TEST

    - name: stg
      subscription: DTS-SHAREDSERVICES-STG
      group: HMI-APIM-BUILD-STG

variables:
  - group: HMI-APIM-Common

stages:
  - template: pipelines/stages/validate.yaml

  - ${{ each environment in parameters.environments }}:
    - ${{ if or(ne(environment, 'stg'), ne(environment, 'prod'), contains(Build.SourceBranch, 'ref/tags/')) }}:
      - template: pipelines/stages/build.yaml
        parameters:
          environment: ${{ environment }}
          subscription: DTS-SHAREDSERVICES-${{ upper(environment) }}

      - ${{ if eq(environment, 'prod') }}:
        - template: pipelines/stages/wait.yaml
          parameters:
            environment: ${{ environment }}

      - template: pipelines/stages/apply.yaml
        parameters:
          environment: ${{ environment }}
          subscription: DTS-SHAREDSERVICES-${{ upper(environment) }}
      
      - ${{ if ne(environment, 'prod' )}}:
        - template: pipelines/stages/test.yaml
          parameters:
            environment: ${{ environment }}
            subscription: DTS-SHAREDSERVICES-${{ upper(environment) }}
        