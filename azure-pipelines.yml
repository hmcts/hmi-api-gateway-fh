---
trigger:
  - none

parameters:
  - name: environment
    displayName: Environment
    type: string
    default: 'sbox'
    values:
      - sbox
      - test

variables:
  - group: HMI-APIM-Common
  - ${{ if eq(parameters.environment, 'sbox') }}:
    - group: HMI-APIM-BUILD-SBOX
  - ${{ if eq(parameters.environment, 'test') }}:
    - group: HMI-APIM-BUILD-TEST

resources:
  containers:
  - container: owasp_zap_container
    image: hmi/apim-tests-owasp:latest
    endpoint: 'DTS-SS-ACRPrivate'
    options: --user 0:0
    ports:
    - 80:80
    volumes:
    - /home/vsts/work/1:/zap/wrk:rw

stages:

  - stage: TEST
    displayName: Create ACR Images
    jobs:
      - job: BuildACRimage
        pool:
          vmImage: 'ubuntu-latest'

        steps:
        - template: pipeline/steps/push-img.yaml
          parameters:
            registry: 'DTS-SS-ACRPrivate'
            repository: 'hmi/apim-tests-owasp'
            dockerfile: 'pipeline/tests/owasp/Dockerfile'
            tags: |
              latest

  - stage: OWASP
    displayName: Tests - OWASP
    jobs:
      - job: containerjob
        pool:
          name: shared-services-pool
        container: owasp_zap_container
        steps:
        - script: |
            echo "Initiating Scan"
            zap-api-scan.py -t https://www.example.com/openapi.json -f openapi
            echo "Finished Scan"