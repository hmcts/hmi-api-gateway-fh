trigger:
  branches:
    include:
      - refs/tags/*
      - master
pr:
  - none

resources:
  repositories:
    - repository: azTemplates
      type: github
      name: hmcts/azure-devops-templates
      ref: refs/heads/tf-testing ##TODO: update to master
      endpoint: hmcts

parameters:

  - name: environments
    type: object
    default:
      - sbox
      - dev
      - test
      - stg
      - prod

variables:
  - group: HMI-APIM-Common

stages:
  - template: pipeline/stages/validate.yaml

  - ${{ each environment in parameters.environments }}:
    - ${{ if or(and(ne(environment, 'stg'), ne(environment, 'prod'), ne(startsWith(variables['Build.SourceBranch'], 'refs/tags/'), True)), and(or(eq(environment, 'stg'), eq(environment, 'prod')), startsWith(variables['Build.SourceBranch'], 'refs/tags/')) ) }}:
      - template: pipeline/stages/plan.yaml
        parameters:
          environment: ${{ environment }}
          subscription: DTS-SHAREDSERVICES-${{ upper(environment) }}

      - ${{ if eq(environment, 'prod') }}:
        - template: pipeline/stages/wait.yaml
          parameters:
            environment: ${{ environment }}

      - template: pipeline/stages/apply.yaml
        parameters:
          environment: ${{ environment }}
          subscription: DTS-SHAREDSERVICES-${{ upper(environment) }}
      
      - ${{ if ne(environment, 'prod' )}}:
        - template: pipeline/stages/test.yaml
          parameters:
            environment: ${{ environment }}
            subscription: DTS-SHAREDSERVICES-${{ upper(environment) }}
        