---
trigger:
  branches:
    include:
      - HMIS-152_SANDBOX_CI/CD_Pipeline

parameters:
  - name: environment
    displayName: Environment
    type: string
    default: 'sbox'
    values:
      - sbox
      - test

variables:
  - group: HMI-APIM-Common
  - ${{ if eq(parameters.environment, 'sbox') }}:
    - group: HMI-APIM-Sbox
  - ${{ if eq(parameters.environment, 'test') }}:
    - group: HMI-APIM-Test

stages:
  - stage: PRESTAGE
    displayName: Read and update variable groups
    jobs:
      - job:
        displayName: "Get Variable Groups"
        steps:
          - task: Bash@3
            inputs:
              filePath: 'pipeline/variables/update_variable_groups.sh'
              arguments: '$(devopsUser), $(devopsPAT)'
              workingDirectory: 'pipeline/variables'

  - stage: TERRAFORM
    displayName: Build infrastructure with Terraform
    jobs:
      - template: pipeline/steps/20-tf-install.yaml
        parameters:
          terraformVersion: $(terraformVersion)
      - template: pipeline/steps/21-tf-init.yaml
        parameters:
          subscription: $(subscription)
          location: $(location)
          environment: $(environment)
          prefix: $(prefix)
          product: $(product)
