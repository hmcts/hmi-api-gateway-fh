---
trigger:
  - none

parameters:
  - name: environments
    type: object
    default: 
      - environment: sbox
      - environment: test

variables:
  - group: HMI-APIM-Common
  - ${{ if eq(parameters.environments.environment, 'sbox') }}:
    - group: HMI-APIM-BUILD-SBOX
  - ${{ if eq(parameters.environments.environment, 'test') }}:
    - group: HMI-APIM-BUILD-TEST


stages:

  - ${{ each env in parameters.environments }}:

    - stage: ${{ env.environment }}

      jobs:

        - job: terraform
          pool:
            vmImage: 'ubuntu-latest'

          steps:
          - script: echo Building sbox... var $(subscription) $(devopsResourceGroup) $(devopsStorageAccount)

        # - template: pipeline/steps/tf-install.yaml
        # - template: pipeline/steps/tf-init.yaml
        #   parameters:
        #     subscription: $(subscription)
        # - template: pipeline/steps/tf-plan.yaml
        #   parameters:
        #     subscription: 'DTS-SHAREDSERVICES-SBOX'
        # - template: pipeline/steps/tf-apply.yaml
        #   parameters:
        #     subscription: 'DTS-SHAREDSERVICES-TEST'
        # - template: pipeline/steps/export-keyvault.yaml
        #   parameters:
        #     subscription: 'DTS-SHAREDSERVICES-SBOX'
        #     keyVaultName: hmi-apim-kv-$(environment)
        #     secret: hmi-apim-sub-key

  # - stage: TEST
  #   # condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/master'))
  #   jobs:
  #   - ${{ if contains(parameters.environment, 'test') }}:
  #     - job: terraform
  #       pool:
  #         vmImage: 'ubuntu-latest'
  #       steps:
  #       - script: echo Building sbox... var $(subscription) $(devopsResourceGroup) $(devopsStorageAccount)
  #       - template: pipeline/steps/tf-install.yaml
  #       - template: pipeline/steps/tf-init.yaml
  #         parameters:
  #           subscription: 'DTS-SHAREDSERVICES-TEST'
  #       - template: pipeline/steps/tf-plan.yaml
  #         parameters:
  #           subscription: 'DTS-SHAREDSERVICES-TEST'
  #       - template: pipeline/steps/tf-apply.yaml
  #         parameters:
  #           subscription: 'DTS-SHAREDSERVICES-TEST'
  #       - template: pipeline/steps/export-keyvault.yaml
  #         parameters:
  #           subscription: 'DTS-SHAREDSERVICES-TEST'
  #           keyVaultName: hmi-apim-kv-$(environment)
  #           secret: hmi-apim-sub-key
