---
trigger:
  - master
pr:
  - none

resources:
  repositories:
    - repository: azTemplates
      type: github
      name: hmcts/azure-devops-templates
      ref: refs/heads/tf-testing
      endpoint: hmcts

parameters:

  - name: environments
    type: object
    default:
      - sbox
      - dev
      - test
      - stg
      - prod

variables:
  - group: HMI-APIM-Common

stages:
  - template: pipelines/stages/validate.yaml

  - ${{ each environment in parameters.environments }}:
    - ${{ if or(ne(environment, 'stg'), ne(environment, 'prod'), contains(Build.SourceBranch, 'ref/tags/')) }}:
      - template: pipelines/stages/build.yaml
        parameters:
          environment: ${{ environment }}
          subscription: DTS-SHAREDSERVICES-${{ upper(environment) }}

      - ${{ if eq(environment, 'prod') }}:
        - template: pipelines/stages/wait.yaml
          parameters:
            environment: ${{ environment }}

      - template: pipelines/stages/apply.yaml
        parameters:
          environment: ${{ environment }}
          subscription: DTS-SHAREDSERVICES-${{ upper(environment) }}
      
      - ${{ if ne(environment, 'prod' )}}:
        - template: pipelines/stages/test.yaml
          parameters:
            environment: ${{ environment }}
            subscription: DTS-SHAREDSERVICES-${{ upper(environment) }}
        