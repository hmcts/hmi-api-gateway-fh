---
trigger:
  - master

parameters:
  - name: environments
    type: object
    default: 
    - name: sbox
      subscription: DTS-SHAREDSERVICES-SBOX
      group: HMI-APIM-BUILD-SBOX
      tests_gradle:
      - name: UnitTest 
        command: clean test
      - name: SmokeTest
        command: clean smoke
        dependsOn: UnitTest
      - name: FunctionalTest
        command: clean functional
        dependsOn: SmokeTest

    - name: test
      subscription: DTS-SHAREDSERVICES-TEST
      group: HMI-APIM-BUILD-TEST
      condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/master'))
      tests_gradle:
      - name: UnitTest 
        command: clean test
      - name: SmokeTest
        command: clean smoke
        dependsOn: UnitTest
      - name: FunctionalTest
        command: clean functional
        dependsOn: SmokeTest

variables:
  - group: HMI-APIM-Common

stages:

  # - stage: TEST
  #   displayName: Create ACR Images
  #   jobs:
  #     - job: BuildACRimage
  #       pool:
  #         vmImage: 'ubuntu-latest'

  #       steps:
  #       - template: pipeline/steps/push-img.yaml
  #         parameters:
  #           registry: 'DTS-SS-ACRPrivate'
  #           repository: 'hmi/apim-tests-owasp'
  #           dockerfile: 'pipeline/tests/owasp/Dockerfile'
  #           tags: |
  #             v0.1


  - stage: OWASP
    displayName: Tests - OWASP
    jobs:
      - job: containerjob
        pool:
          vmImage: 'ubuntu-latest'
        # container: owasp_zap_container
        steps:

        # - script: |
        #     docker run -e TEST_URL=https://www.example.com/openapi.json -e SecurityRules=https://raw.githubusercontent.com/hmcts/security-test-rules/master/conf/security-rules.conf -v /home/vsts/work/1:/zap/wrk:rw owasp/zap2docker-weekly /bin/bash -c ./security.sh
        #     ls /home/vsts/work/1

        - task: Docker@0
          displayName: 'Run an image'
          inputs:
            azureSubscription: 'DTS-SHAREDSERVICES-SBOX'
            azureContainerRegistry: '{"loginServer":"ssprivatesbox.azurecr.io", "id" : "/subscriptions/a8140a9e-f1b0-481f-a4de-09e2ee23f7ab/resourceGroups/infra-resource-group/providers/Microsoft.ContainerRegistry/registries/ssprivatesbox"}'
            action: 'Run an image'
            imageName: 'ssprivatesbox.azurecr.io/hmi/apim-tests-owasp:v0.1'
            volumes: '/home/vsts/work/1:/zap/wrk:rw'
            envVars: |
              TEST_URL=https://www.example.com/openapi.json
              SecurityRules=https://raw.githubusercontent.com/hmcts/security-test-rules/master/conf/security-rules.conf
            containerCommand: ./security.sh
        
        - script: |
            docker run -e TEST_URL=https://www.example.com/openapi.json -e SecurityRules=https://raw.githubusercontent.com/hmcts/security-test-rules/master/conf/security-rules.conf -v /home/vsts/work/1:/zap/wrk:rw -it ssprivatesbox.azurecr.io/hmi/apim-tests-owasp:v0.1 /bin/bash ./security.sh
            ls -la /home/vsts/work/1/TestResults/
