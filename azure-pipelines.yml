---
trigger:
  - master

parameters:
  - name: environments
    type: object
    default: 
    - name: sbox
      subscription: DTS-SHAREDSERVICES-SBOX
      group: HMI-APIM-BUILD-SBOX
    - name: test
      subscription: DTS-SHAREDSERVICES-SBOX
      group: HMI-APIM-BUILD-SBOX
      condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/master'))

variables:
  - group: HMI-APIM-Common

stages:

- ${{ each environment in parameters.environments }}:

  - stage: ${{ environment.name }}
  # - ${{ if environment.contidion }}:
  #   condition: ${{ environment.contidion }}
    displayName: Build and Test ${{ environment.name }} APIM
    
    jobs:

    - template: pipeline/jobs/terraform.yaml
      parameters:
        subscription: ${{ environment.subscription }} 
        group: HMI-APIM-BUILD-SBOX
        displayName: Build infrastructure with Terraform

    - template: pipeline/steps/export-keyvault.yaml
      parameters:
        displayName: Read KeyVault Secret
        dependsOn: Terraform
        subscription: ${{ environment.subscription }}
        keyVaultName: hmi-apim-kv-${{ environment.name }}

    - template: pipeline/jobs/gradle-test.yaml
      parameters:
        displayName: Unit Test
        dependsOn: ReadKVSecret
        apimHost: hmi-apim-svc-sbox.azure-api.net
        command: clean test
        subscriptionKey: $[dependencies.ReadKVSecret.outputs['exportKeyVaultSecret.hmi-apim-sub-key']]