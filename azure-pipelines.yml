---
trigger:
  - none

parameters:
  - name: environment
    displayName: Environment
    type: string
    default: 'sbox'
    values:
      - sbox
      - test

variables:
  - group: HMI-APIM-Common
  - ${{ if eq(parameters.environment, 'sbox') }}:
    - group: HMI-APIM-BUILD-SBOX
  - ${{ if eq(parameters.environment, 'test') }}:
    - group: HMI-APIM-BUILD-TEST

stages:

  - stage: BUILD
    displayName: Build infrastructure with Terraform
    jobs:
      - job: Terraform
        pool:
          vmImage: 'ubuntu-latest'
        steps:
        - template: pipeline/steps/tf-install.yaml
        - template: pipeline/steps/tf-init.yaml
          parameters:
            resourceGroup: $(devopsResourceGroup)
            storageAccount: $(devopsStorageAccount)
        - template: pipeline/steps/tf-plan.yaml
        - template: pipeline/steps/tf-apply.yaml
        - template: pipeline/steps/export-keyvault.yaml
          parameters:
            keyVaultName: hmi-apim-kv-$(environment)
            secret: hmi-apim-sub-key


  - stage: TESTS1
    dependsOn: BUILD
    displayName: Tests - Functional
    jobs:
    - job: testfunc
      variables:
        hmi-apim-sub-key: $[stageDependencies.BUILD.Terraform.outputs['exportKeyVaultSecret.subscription_key']]
        hmi-apim-host: hmi-apim-svc-sbox.azure-api.net
      pool:
        vmImage: 'ubuntu-latest'
      steps:
      - task: Gradle@2
        inputs:
          gradleWrapperFile: 'gradlew'
          workingDirectory: '$(System.DefaultWorkingDirectory)'
          tasks: clean functional -DTEST_SUBSCRIPTION_KEY=$(hmi-apim-sub-key) -DTEST_URL=https://hmi-apim-svc-sbox.azure-api.net -DTEST_HOST=$(hmi-apim-host)
          publishJUnitResults: true
          testResultsFiles: '**/TEST-*.xml'
          javaHomeOption: 'JDKVersion'
          jdkVersionOption: '1.11'
          sonarQubeRunAnalysis: false


  - stage: TESTS2
    dependsOn: BUILD
    displayName: Tests - Smoke
    jobs:
    - job: testsmoke
      variables:
        hmi-apim-sub-key: $[stageDependencies.BUILD.Terraform.outputs['exportKeyVaultSecret.subscription_key']]
        hmi-apim-host: hmi-apim-svc-sbox.azure-api.net
      pool:
        vmImage: 'ubuntu-latest'
      steps:
      - task: Gradle@2
        inputs:
          gradleWrapperFile: 'gradlew'
          workingDirectory: '$(System.DefaultWorkingDirectory)'
          tasks: clean smoke -DTEST_SUBSCRIPTION_KEY=$(hmi-apim-sub-key) -DTEST_URL=https://$(hmi-apim-host) -DTEST_HOST=$(hmi-apim-host)
          publishJUnitResults: true
          testResultsFiles: '**/TEST-*.xml'
          javaHomeOption: 'JDKVersion'
          jdkVersionOption: '1.11'
          sonarQubeRunAnalysis: false


  - stage: TESTS3
    dependsOn: BUILD
    displayName: Tests - Unit
    jobs:
    - job: testunit
      variables:
        hmi-apim-sub-key: $[stageDependencies.BUILD.Terraform.outputs['exportKeyVaultSecret.subscription_key']]
        hmi-apim-host: hmi-apim-svc-sbox.azure-api.net
      pool:
        vmImage: 'ubuntu-latest'
      steps:
      - task: Gradle@2
        inputs:
          gradleWrapperFile: 'gradlew'
          workingDirectory: '$(System.DefaultWorkingDirectory)'
          tasks: clean test -DTEST_SUBSCRIPTION_KEY=$(hmi-apim-sub-key) -DTEST_URL=https://$(hmi-apim-host) -DTEST_HOST=$(hmi-apim-host)
          publishJUnitResults: true
          testResultsFiles: '**/TEST-*.xml'
          javaHomeOption: 'JDKVersion'
          jdkVersionOption: '1.11'
          sonarQubeRunAnalysis: false
