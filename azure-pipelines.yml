---
trigger:
  - none

parameters:
  - name: environment
    type: string
    default: 'sbox,test'

variables:
  - group: HMI-APIM-Common
  - ${{ if eq(parameters.environment, 'sbox') }}:
    - group: HMI-APIM-BUILD-SBOX
  - ${{ if eq(parameters.environment, 'test') }}:
    - group: HMI-APIM-BUILD-TEST

stages:

  - stage: SANDBOX
    displayName: Build and Test SANDBOX APIM
    
    jobs:
      - job: Terraform
        displayName: Build infrastructure with Terraform
        pool:
          vmImage: 'ubuntu-latest'
        steps:
        - template: pipeline/steps/tf-install.yaml
        - template: pipeline/steps/tf-init.yaml
          parameters:
            resourceGroup: $(devopsResourceGroup)
            storageAccount: $(devopsStorageAccount)
        - template: pipeline/steps/tf-plan.yaml
        - template: pipeline/steps/tf-apply.yaml
        - template: pipeline/steps/export-keyvault.yaml
          parameters:
            keyVaultName: hmi-apim-kv-$(environment)

      - job: TestUnit
        dependsOn: Terraform
        displayName: Unit Test
        variables:
          hmi-apim-sub-key: $[dependencies.Terraform.outputs['exportKeyVaultSecret.hmi-apim-sub-key']]
          hmi-apim-host: hmi-apim-svc-sbox.azure-api.net
        pool:
          vmImage: 'windows-latest'
        steps:
        - template: pipeline/steps/run-gradlew.yaml
          parameters:
            runCommand: clean test -DTEST_SUBSCRIPTION_KEY=$(hmi-apim-sub-key) -DTEST_URL=https://$(hmi-apim-host) -DTEST_HOST=$(hmi-apim-host)

      - job: TestSmoke
        dependsOn: TestUnit
        displayName: Smoke Test
        variables:
          hmi-apim-sub-key: $[dependencies.Terraform.outputs['exportKeyVaultSecret.hmi-apim-sub-key']]
          hmi-apim-host: hmi-apim-svc-sbox.azure-api.net
        pool:
          vmImage: 'windows-latest'
        steps:
        - template: pipeline/steps/run-gradlew.yaml
          parameters:
            runCommand: clean smoke -DTEST_SUBSCRIPTION_KEY=$(hmi-apim-sub-key) -DTEST_URL=https://$(hmi-apim-host) -DTEST_HOST=$(hmi-apim-host)

      # - job: TestAcceptance - PLACEHOLDER
      #   displayName: Acceptance Test
      # - job: TestContract - PLACEHOLDER
      #   displayName: Contract Test

      - job: TestFunctional
        displayName: Functional Test
        variables:
          hmi-apim-sub-key: $[dependencies.Terraform.outputs['exportKeyVaultSecret.hmi-apim-sub-key']]
          hmi-apim-host: hmi-apim-svc-sbox.azure-api.net
        pool:
          vmImage: 'windows-latest'
        steps:
        - template: pipeline/steps/run-gradlew.yaml
          parameters:
            runCommand: clean functional -DTEST_SUBSCRIPTION_KEY=$(hmi-apim-sub-key) -DTEST_URL=https://$(hmi-apim-host).azure-api.net -DTEST_HOST=$(hmi-apim-host)

      # - job: TestSecurity - PLACEHOLDER
      #   displayName: Security Test
      # - job: TestCodeQuality - PLACEHOLDER
      #   displayName: Code Quality Test


  - stage: TEST
    displayName: Build and Test TEST APIM
    
    jobs:
      - job: Terraform
        displayName: Build infrastructure with Terraform
        pool:
          vmImage: 'ubuntu-latest'
        steps:
        - template: pipeline/steps/tf-install.yaml
        - template: pipeline/steps/tf-init.yaml
          parameters:
            resourceGroup: $(devopsResourceGroup)
            storageAccount: $(devopsStorageAccount)
        - template: pipeline/steps/tf-plan.yaml
        - template: pipeline/steps/tf-apply.yaml
        - template: pipeline/steps/export-keyvault.yaml
          parameters:
            keyVaultName: hmi-apim-kv-$(environment)

      - job: TestUnit
        dependsOn: Terraform
        displayName: Unit Test
        variables:
          hmi-apim-sub-key: $[dependencies.Terraform.outputs['exportKeyVaultSecret.hmi-apim-sub-key']]
          hmi-apim-host: hmi-apim-svc-sbox.azure-api.net
        pool:
          vmImage: 'windows-latest'
        steps:
        - template: pipeline/steps/run-gradlew.yaml
          parameters:
            runCommand: clean test -DTEST_SUBSCRIPTION_KEY=$(hmi-apim-sub-key) -DTEST_URL=https://$(hmi-apim-host) -DTEST_HOST=$(hmi-apim-host)

      - job: TestSmoke
        dependsOn: TestUnit
        displayName: Smoke Test
        variables:
          hmi-apim-sub-key: $[dependencies.Terraform.outputs['exportKeyVaultSecret.hmi-apim-sub-key']]
          hmi-apim-host: hmi-apim-svc-sbox.azure-api.net
        pool:
          vmImage: 'windows-latest'
        steps:
        - template: pipeline/steps/run-gradlew.yaml
          parameters:
            runCommand: clean smoke -DTEST_SUBSCRIPTION_KEY=$(hmi-apim-sub-key) -DTEST_URL=https://$(hmi-apim-host) -DTEST_HOST=$(hmi-apim-host)

      # - job: TestAcceptance - PLACEHOLDER
      #   displayName: Acceptance Test
      # - job: TestContract - PLACEHOLDER
      #   displayName: Contract Test

      - job: TestFunctional
        displayName: Functional Test
        variables:
          hmi-apim-sub-key: $[dependencies.Terraform.outputs['exportKeyVaultSecret.hmi-apim-sub-key']]
          hmi-apim-host: hmi-apim-svc-sbox.azure-api.net
        pool:
          vmImage: 'windows-latest'
        steps:
        - template: pipeline/steps/run-gradlew.yaml
          parameters:
            runCommand: clean functional -DTEST_SUBSCRIPTION_KEY=$(hmi-apim-sub-key) -DTEST_URL=https://$(hmi-apim-host).azure-api.net -DTEST_HOST=$(hmi-apim-host)

      # - job: TestSecurity - PLACEHOLDER
      #   displayName: Security Test
      # - job: TestCodeQuality - PLACEHOLDER
      #   displayName: Code Quality Test