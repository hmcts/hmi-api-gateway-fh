---
trigger:
  - master

parameters:
  - name: environments
    type: object
    default: 
    - name: sbox
      subscription: DTS-SHAREDSERVICES-SBOX
      group: HMI-APIM-BUILD-SBOX
      tests_gradle:
      - name: Unit Test 
        command: clean test
      - name: Smoke Test
        command: clean smoke
      - name: Functional Test
        command: clean functional

    # - name: test
    #   subscription: DTS-SHAREDSERVICES-SBOX
    #   group: HMI-APIM-BUILD-SBOX
    #   condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/master'))

variables:
  - group: HMI-APIM-Common

stages:

- ${{ each environment in parameters.environments }}:

  - stage: ${{ environment.name }}
    # ${{ if environment.condition }}:
    # condition: ${{ environment.condition }}
    displayName: Build and Test ${{ environment.name }} APIM
    
    jobs:

    - template: pipeline/jobs/terraform.yaml
      parameters:
        subscription: ${{ environment.subscription }} 
        group: HMI-APIM-BUILD-SBOX
        displayName: Build infrastructure with Terraform

    - template: pipeline/jobs/export-keyvault.yaml
      parameters:
        displayName: Read KeyVault Secret
        dependsOn: Terraform
        subscription: ${{ environment.subscription }}
        keyVaultName: hmi-apim-kv-${{ environment.name }}

    ${{ if environment.tests_gradle }}:
    - ${{ each test in environment.tests_gradle }}:

    - template: pipeline/jobs/gradle-test.yaml
      parameters:
        displayName: ${{ test.name }}
        dependsOn: ExportKeyVault
        apimHost: hmi-apim-svc-sbox.azure-api.net
        command: ${{ test.command }}
        subscriptionKey: $[dependencies.ExportKeyVault.outputs['exportKeyVaultSecret.hmi-apim-sub-key']]