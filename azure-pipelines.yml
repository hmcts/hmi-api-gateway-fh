---
trigger:
  - master

parameters:
  - name: environments
    type: object
    default: 
    - name: sbox
      subscription: DTS-SHAREDSERVICES-SBOX
      group: HMI-APIM-BUILD-SBOX
      tests_gradle:
      - name: UnitTest 
        command: clean test
      - name: SmokeTest
        command: clean smoke
        dependsOn: UnitTest
      - name: FunctionalTest
        command: clean functional
        dependsOn: SmokeTest

    - name: test
      subscription: DTS-SHAREDSERVICES-TEST
      group: HMI-APIM-BUILD-TEST
      condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/master'))
      tests_gradle:
      - name: UnitTest 
        command: clean test
      - name: SmokeTest
        command: clean smoke
        dependsOn: UnitTest
      - name: FunctionalTest
        command: clean functional
        dependsOn: SmokeTest

  - name: images
    type: object
    default:
    - name: azure_devops_agent
      repository: 'hmi/azure-devops-agent'
    - name: owasp_zap_scan
      repository: 'hmi/apim-tests-owasp'
    - name: wiremock
      repository: 'hmi/apim-test-wiremock'

variables:
  - group: HMI-APIM-Common

resources:
  containers:
  - container: owasp_zap_container
    image: hmi/apim-tests-owasp:v1.0
    endpoint: 'DTS-SS-ACRPrivate'
    options: --user 0:0
    ports:
    - 80:80
    volumes:
    - /home/vsts/work/1:/zap/wrk:rw


stages:

  - stage: TEST
    displayName: Create ACR Images
    jobs:
      - job: BuildACRimage
        pool:
          vmImage: 'ubuntu-latest'

        steps:
        - template: pipeline/steps/push-img.yaml
          parameters:
            registry: 'DTS-SHAREDSERVICES-ACR-SBOX'
            repository: 'hmi/apim-tests-owasp'
            dockerfile: 'pipeline/tests/owasp/Dockerfile'
            tags: |
              v1.0

        - template: pipeline/steps/push-img.yaml
          parameters:
            registry: 'DTS-SHAREDSERVICES-ACR-SBOX'
            repository: 'hmi/azure-devops-agent'
            dockerfile: 'docker/images/azuredevops-agent/Dockerfile'
            tags: |
              v1.0

        - script: |
            docker run hello-world

  # - stage: OWASP
  #   displayName: Tests - OWASP
  #   jobs:
  #     - job: containerjob
  #       pool:
  #         name: hmi-pool
  #       container: owasp_zap_container
  #       steps:
  #       - script: |
  #           echo "Initiating Scan"
  #           zap-api-scan.py -t https://www.example.com/openapi.json -f openapi
  #           echo "Finished Scan"
