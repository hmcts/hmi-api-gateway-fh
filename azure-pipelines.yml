---
trigger:
  - none

parameters:
  - name: environment
    type: string
    default: 'sbox,test'

variables:
  - group: HMI-APIM-Common

stages:

  - stage: SANDBOX
    jobs:
    - ${{ if contains(parameters.environment, 'sbox') }}:
      - job: terraform
        pool:
          vmImage: 'ubuntu-latest'
        variables:
        - group: HMI-APIM-BUILD-SBOX
        steps:

        - script: echo Building sbox... var $(subscription) $(devopsResourceGroup) $(devopsStorageAccount)
        - template: pipeline/steps/echo.yaml
          parameters:
            sub: ${{ variables.subscription }}
            subs: $(subscription)
        - template: pipeline/steps/tf-install.yaml
        - template: pipeline/steps/tf-init.yaml
          parameters:
            subscription: 'DTS-SHAREDSERVICES-SBOX'
        - template: pipeline/steps/tf-plan.yaml
          parameters:
            subscription: 'DTS-SHAREDSERVICES-SBOX'

  - stage: TEST
    jobs:
    - ${{ if contains(parameters.environment, 'test') }}:
      - job: test
        variables:
        - group: HMI-APIM-BUILD-TEST
        steps:
        - script: echo Building test... $(subscription)
        - template: pipeline/steps/echo.yaml
          parameters:
            sub: ${{ variables.subscription }}
            subs: $(subscription)
        - template: pipeline/steps/tf-install.yaml
        - template: pipeline/steps/tf-init.yaml
          parameters:
            subscription: 'DTS-SHAREDSERVICES-TEST'
        - template: pipeline/steps/tf-plan.yaml
          parameters:
            subscription: 'DTS-SHAREDSERVICES-TEST'
