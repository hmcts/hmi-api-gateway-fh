---
trigger:
  - master

parameters:
  - name: environments
    type: object
    default: 
    - env_name: sbox
      subscription: DTS-SHAREDSERVICES-SBOX
      group: HMI-APIM-BUILD-SBOX
    # - env_name: test

variables:
  - group: HMI-APIM-Common

stages:

- ${{ each environment in parameters.environments }}:

  - stage: ${{ environment.env_name }}
    displayName: Build and Test ${{ environment.env_name }} APIM
    
    jobs:

    - template: pipeline/jobs/terraform.yaml
      parameters:
        subscription: ${{ environment.subscription }} # DTS-SHAREDSERVICES-SBOX
        group: HMI-APIM-BUILD-SBOX
        displayName: Build infrastructure with Terraform

    - job: ReadKVSecret
      displayName: ReadKVSecret
      steps:
      - template: pipeline/steps/export-keyvault.yaml
        parameters:
          subscription: ${{ environment.subscription }}
          keyVaultName: hmi-apim-kv-$(environment)

    - template: pipeline/jobs/gradle-test.yaml
      parameters:
        dependsOn: ReadKVSecret
        displayName: Unit Test
        apimHost: hmi-apim-svc-sbox.azure-api.net
        command: clean test
        subscriptionKey: $[dependencies.ReadKVSecret.outputs['exportKeyVaultSecret.hmi-apim-sub-key']]