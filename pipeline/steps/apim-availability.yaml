parameters:
  - name: subscriptionName
    type: string
  - name: apimName
    type: string
  - name: resourceGroupName
    type: string

steps:
  - template: templates\Azure\Common\check-soft-deleted.yaml@azTemplates
    parameters: 
      subscriptionName: ${{ parameters.subscriptionName }}
      resourceName: ${{ parameters.apimName }}
      resourceLocation: $(location)
      variableName: available
      taskName: apim
  
  - bash: |
      echo "available: $available"
      purge=false
      if [[ "$available" == "false" ]]; then
        purge=true
      fi
      echo "##vso[task.setvariable variable=purge;isOutput=true]${purge}"
    displayName: "Determine if to purge"
    name: evaluate
    env:
      available: $(apim.available)

  - template: templates\Azure\ApiManagement\purge.yaml@azTemplates
    parameters: 
      subscriptionName: ${{ parameters.subscriptionName }}
      apimName: ${{ parameters.apimName }}
      apimLocation: $(location)
      shouldPurge: "$(evaluate.purge)"