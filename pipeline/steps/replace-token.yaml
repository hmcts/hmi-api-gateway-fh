parameters:
  - name: secure_file
    type: string

steps:
- task: DownloadSecureFile@1
  displayName: 'Download secure file'
  inputs:
    secureFile: ${{ parameters.secure_file }}
- bash:
    pwd
    ls
    ls $(Agent.TempDirectory)
    # mv $(Agent.TempDirectory)/${{ parameters.secure_file }} pipeline/variables/
- task: replacetokens@3
  displayName: Replace Tokens in Policy files
  inputs:
    targetFiles: '**/*-policy.xml'
    encoding: 'auto'
    writeBOM: true
    actionOnMissing: 'warn'
    keepToken: false
    tokenPrefix: '#{'
    tokenSuffix: '}#'
    useLegacyPattern: false
    variableFiles: 'pipeline/variables/policy-variables-$(environment).json'
    enableTelemetry: true
- bash:
    rm -rf pipeline/variables/${{ parameters.secure_file }}
