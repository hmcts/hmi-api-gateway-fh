parameters:
  - name: subscription
    type: string
    
steps:
- task: AzurePowerShell@5
  displayName: Apply Policies to APIM API
  inputs:
    azureSubscription: ${{ parameters.subscription }}
    ScriptType: 'InlineScript'
    Inline: |
      $apimContext = New-AzApiManagementContext -ResourceGroupName $(resourceGroup) -ServiceName "hmi-apim-svc-$(environment)"
      $policies = Get-ChildItem $(System.DefaultWorkingDirectory)\infrastructure\template\ -Recurse *.xml
      foreach ($_ in $policies) {
        Write-Host "Applying $_"
        Set-AzApiManagementPolicy -Context $apimContext -ApiId "hmi-apim-api" -PolicyFilePath $(System.DefaultWorkingDirectory)\infrastructure\template\$_"
      }
    azurePowerShellVersion: 'LatestVersion'
