parameters:
  - name: subscription
    type: string

steps:

- task: replacetokens@3
  displayName: Replace Tokens in Policy files
  inputs:
    rootDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/terraform/'
    targetFiles: '**/*-policy.xml'
    encoding: 'auto'
    writeBOM: true
    actionOnMissing: 'warn'
    keepToken: false
    tokenPrefix: '#{'
    tokenSuffix: '}#'
    useLegacyPattern: false
    variableFiles: 'pipeline/variables/policy-variables-$(environment).json'
    enableTelemetry: true
    
- task: TerraformCLI@0
  displayName: Terraform apply
  inputs:
    command: apply
    workingDirectory: $(System.DefaultWorkingDirectory)/infrastructure/terraform/
    environmentServiceName: ${{ parameters.subscription }}
    commandOptions: -auto-approve tfplan-$(environment)
