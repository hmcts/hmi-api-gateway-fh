parameters:
  - name: subscription
    type: string

variables:
  tfstate: $(prefix)$(product).tfstate

steps:
- task: AzureCLI@2
  displayName: Get Terraform Outputs
  name: getOutputs
  inputs:
    azureSubscription: ${{ parameters.subscription }}
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      echo "Obtaining container key..."
      key=$(az storage account keys list -g $(devopsResourceGroup) --account-name $(devopsStorageAccount) --query "[0].value" -o tsv)
      echo "Creating storage container"
      az storage blob download --container-name $(prefix)$(product)terraform --file $(tfstate) --name $(tfstate) --account-name $(devopsStorageAccount) --account-key $key
      echo "##vso[task.setvariable variable=apimGatewayUrl;isOutput=true;isSecret=true;]=$(terraform output -state=$(tfstate) hmi_apim_gateway_url)
      echo "##vso[task.setvariable variable=subscriptionKey;isOutput=true;isSecret=true;]$(terraform output -state=$(tfstate) subscription_key)
      echo "##vso[task.setvariable variable=storageAccount;isOutput=true;isSecret=true;]$(terraform output -state=$(tfstate) storage_account)
      