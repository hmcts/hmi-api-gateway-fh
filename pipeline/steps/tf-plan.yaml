parameters:
  - name: subscription
    type: string

steps:

- task: AzurePowerShell@5
  displayName: Replace Tokens
  inputs:
    azureSubscription: ${{ parameters.subscription }}
    ScriptType: 'FilePath'
    ScriptPath: '$(System.DefaultWorkingDirectory)/script/replace-token.ps1'
    errorActionPreference: 'continue'
    azurePowerShellVersion: 'LatestVersion'

- task: TerraformCLI@0
  displayName: Terraform plan
  inputs:
    command: plan
    workingDirectory: $(System.DefaultWorkingDirectory)/infrastructure/terraform/
    environmentServiceName: ${{ parameters.subscription }}
    commandOptions: '-var-file="environment/$(environment)-hmi.tfvars" -out="tfplan-$(environment)" -var "tenant_id=$(tenant_id)" -var "sp_object_id=$(sp_object_id)" -var "prefix=$(prefix)" -var "product=$(product)" -var "environment=$(environment)" -var "location=$(location)" -var "repo_branch=$(Build.SourceVersion)"'
